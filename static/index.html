<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“Š BOAMP Data Extractor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .progress {
            height: 8px;
            border-radius: 10px;
        }
        
        .department-badge {
            background: var(--secondary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.8rem;
            margin: 0.1rem;
        }
        
        .stat-card {
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .btn-primary {
            background: var(--secondary);
            border: none;
            padding: 0.75rem 2rem;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .loading-spinner {
            display: none;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Map Styles - FIXED */
        #map {
            height: 550px;
            border-radius: 10px;
            z-index: 1;
            background-color: #f8f9fa; /* Fallback background */
        }
        
        .map-container {
            position: relative;
            min-height: 550px;
        }
        
        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 700;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border: 1px solid #ccc;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }
        
        .legend-color {
            width: 20px;
            height: 15px;
            margin-right: 8px;
            border: 1px solid #666;
        }
        
        .department-info {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            max-width: 250px;
            display: none;
            border: 1px solid #ccc;
        }
        
        .tab-content {
            min-height: 500px;
        }
        
        /* Ensure map tab content is visible during initialization */
        #map-view.tab-pane {
            position: relative;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand">
                <i class="fas fa-chart-bar me-2"></i>BOAMP Data Extractor
            </span>
        </div>
    </nav>

    <div class="container my-5">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-4 text-center">
                    <h1 class="display-6 fw-bold text-dark mb-3">ðŸ“Š BOAMP Data Extractor</h1>
                    <p class="lead text-muted">
                        Extract public procurement notices from BOAMP and filter by departments
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Configuration Panel -->
            <div class="col-lg-4 mb-4">
                <div class="glass-card p-4 h-100">
                    <h4 class="fw-bold mb-4">
                        <i class="fas fa-cog me-2"></i>Configuration
                    </h4>
                    
                    <!-- Date Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Target Date</label>
                        <input type="date" class="form-control" id="targetDate" value="">
                    </div>
                    
                    <!-- Department Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Target Departments</label>
                        <input type="text" class="form-control" id="departments" 
                               value="75, 77, 78, 91, 92, 93, 95, 94, 27, 60, 76, 28"
                               placeholder="Enter department codes separated by commas">
                        <div class="form-text">Example: 75, 77, 78, 91, 92, 93, 95, 94</div>
                    </div>
                    
                    <!-- Max Records -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Maximum Records</label>
                        <input type="number" class="form-control" id="maxRecords" value="5000" min="100" max="10000" step="100">
                    </div>
                    
                    <!-- Extract Button -->
                    <button class="btn btn-primary w-100 py-3 fw-bold" onclick="startExtraction()">
                        <i class="fas fa-rocket me-2"></i>Extract BOAMP Data
                    </button>
                    
                    <div class="loading-spinner text-center mt-3" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted" id="loadingText">Starting extraction...</p>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="col-lg-8">
                <div class="glass-card p-4 h-100">
                    <h4 class="fw-bold mb-4">
                        <i class="fas fa-chart-line me-2"></i>Results
                    </h4>
                    
                    <!-- Status Display -->
                    <div id="statusArea" class="d-none">
                        <div class="alert alert-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <span id="statusMessage">Processing...</span>
                                <span id="progressText">0%</span>
                            </div>
                            <div class="progress mt-2">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Tabs -->
                    <ul class="nav nav-tabs" id="resultsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab">Statistics</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-view" type="button" role="tab" onclick="initMapIfNeeded()">Map View</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab">Charts</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="resultsTabContent">
                        <!-- Statistics Tab -->
                        <div class="tab-pane fade show active" id="stats" role="tabpanel">
                            <!-- Statistics -->
                            <div id="statsArea" class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="stat-card card border-0 shadow-sm">
                                        <div class="card-body text-center">
                                            <h3 class="text-primary" id="totalRecords">0</h3>
                                            <p class="text-muted mb-0">Total Records</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="stat-card card border-0 shadow-sm">
                                        <div class="card-body text-center">
                                            <h3 class="text-success" id="filteredRecords">0</h3>
                                            <p class="text-muted mb-0">Filtered Records</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Download Buttons -->
                            <div id="downloadArea" class="mt-4">
                                <h5 class="fw-semibold mb-3">Download Results</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <button class="btn btn-outline-primary w-100" onclick="downloadFullData()">
                                            <i class="fas fa-download me-2"></i>Download All Data
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <button class="btn btn-outline-success w-100" onclick="downloadFilteredData()">
                                            <i class="fas fa-filter me-2"></i>Download Filtered Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Instructions -->
                            <div id="instructions" class="mt-4">
                                <div class="alert alert-light">
                                    <h6 class="fw-bold"><i class="fas fa-info-circle me-2"></i>Instructions</h6>
                                    <ul class="mb-0 small">
                                        <li>Select the target date for BOAMP notices</li>
                                        <li>Enter department codes (comma-separated)</li>
                                        <li>Set maximum records to fetch</li>
                                        <li>Click "Extract BOAMP Data" to start</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Map Tab -->
                        <div class="tab-pane fade" id="map-view" role="tabpanel">
                            <div class="map-container">
                                <div id="map">
                                    <div class="text-center p-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading map...</span>
                                        </div>
                                        <p class="mt-2">Loading map...</p>
                                    </div>
                                </div>
                                <div class="department-info" id="departmentInfo">
                                    <h6 id="deptName">Department Name</h6>
                                    <p class="mb-1" id="deptCode">Code: </p>
                                    <p class="mb-1" id="deptCount">Records: 0</p>
                                </div>
                                <div class="map-legend">
                                    <h6>Records Count</h6>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #ffffcc"></div>
                                        <span>0</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #a1dab4"></div>
                                        <span>1-10</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #41b6c4"></div>
                                        <span>11-50</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #2c7fb8"></div>
                                        <span>51-100</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #253494"></div>
                                        <span>100+</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts Tab -->
                        <div class="tab-pane fade" id="charts" role="tabpanel">
                            <!-- Department Distribution -->
                            <div id="chartArea" class="mt-4">
                                <h5 class="fw-semibold mb-3">Department Distribution</h5>
                                <div class="chart-container">
                                    <canvas id="departmentChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Set default date to today
        document.getElementById('targetDate').valueAsDate = new Date();
        
        let currentJobId = null;
        let departmentChart = null;
        let checkInterval = null;
        let map = null;
        let geojsonLayer = null;
        let mapInitialized = false;

        // Initialize the map only when needed
        function initMapIfNeeded() {
            if (mapInitialized) {
                // If map already exists, just invalidate size to fix rendering
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 100);
                return;
            }
            
            // Create map centered on France
            map = L.map('map').setView([46.603354, 1.888334], 6);
            
            // Add tile layer with error handling
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Add error event listener to tile layer
            map.on('tileerror', function(error) {
                console.error('Map tile loading error:', error);
            });
            
            // Load France departments GeoJSON
            loadFranceGeoJSON();
            mapInitialized = true;
        }
        
        // Load France departments GeoJSON with fallback
        async function loadFranceGeoJSON() {
            try {
                // Try multiple GeoJSON sources
                const geojsonSources = [
                    'https://france-geojson.gregoiredavid.fr/repo/departements.geojson',
                    'https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements.geojson'
                ];
                
                let geojsonData = null;
                let lastError = null;
                
                for (const source of geojsonSources) {
                    try {
                        console.log('Trying GeoJSON source:', source);
                        const response = await fetch(source);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        geojsonData = await response.json();
                        console.log('Successfully loaded GeoJSON from:', source);
                        break;
                    } catch (error) {
                        console.warn('Failed to load from', source, error);
                        lastError = error;
                        continue;
                    }
                }
                
                if (!geojsonData) {
                    throw lastError || new Error('All GeoJSON sources failed');
                }
                
                // Style function for departments
                function style(feature) {
                    return {
                        fillColor: getColor(0),
                        weight: 1,
                        opacity: 1,
                        color: 'white',
                        dashArray: '3',
                        fillOpacity: 0.7
                    };
                }
                
                // Highlight feature on hover
                function highlightFeature(e) {
                    const layer = e.target;
                    
                    layer.setStyle({
                        weight: 3,
                        color: '#666',
                        dashArray: '',
                        fillOpacity: 0.9
                    });
                    
                    layer.bringToFront();
                    
                    // Update department info
                    const infoDiv = document.getElementById('departmentInfo');
                    infoDiv.style.display = 'block';
                    document.getElementById('deptName').textContent = layer.feature.properties.nom;
                    document.getElementById('deptCode').textContent = 'Code: ' + layer.feature.properties.code;
                    document.getElementById('deptCount').textContent = 'Records: ' + (layer.feature.recordCount || 0);
                }
                
                // Reset highlight
                function resetHighlight(e) {
                    if (geojsonLayer) {
                        geojsonLayer.resetStyle(e.target);
                    }
                    document.getElementById('departmentInfo').style.display = 'none';
                }
                
                // Zoom to feature on click
                function zoomToFeature(e) {
                    map.fitBounds(e.target.getBounds(), { padding: [20, 20] });
                }
                
                // Add event listeners to each feature
                function onEachFeature(feature, layer) {
                    layer.on({
                        mouseover: highlightFeature,
                        mouseout: resetHighlight,
                        click: zoomToFeature
                    });
                }
                
                // Add GeoJSON to map
                geojsonLayer = L.geoJSON(geojsonData, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);
                
            } catch (error) {
                console.error('Error loading GeoJSON:', error);
                // Show error message on map
                const mapContainer = document.getElementById('map');
                mapContainer.innerHTML = `
                    <div class="alert alert-danger m-3">
                        <h6>Error loading map data</h6>
                        <p class="mb-0">Unable to load department boundaries. Please check your internet connection.</p>
                    </div>
                `;
            }
        }
        
        // Get color based on record count
        function getColor(count) {
            return count === 0 ? '#ffffcc' :
                   count <= 10 ? '#a1dab4' :
                   count <= 50 ? '#41b6c4' :
                   count <= 100 ? '#2c7fb8' :
                   '#253494';
        }
        
        // Update map with department data
        function updateMapWithData(departmentDistribution) {
            if (!geojsonLayer || !map) return;
            
            // Update each feature with record count and style
            geojsonLayer.eachLayer(function(layer) {
                const deptCode = layer.feature.properties.code;
                const recordCount = departmentDistribution[deptCode] || 0;
                
                // Store record count in feature for display
                layer.feature.recordCount = recordCount;
                
                // Update style based on record count
                layer.setStyle({
                    fillColor: getColor(recordCount),
                    weight: 1,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.7
                });
            });
            
            // Refresh map
            map.invalidateSize();
        }

        // Add tab change event listener to handle map resizing
        document.addEventListener('DOMContentLoaded', function() {
            const mapTab = document.getElementById('map-tab');
            if (mapTab) {
                mapTab.addEventListener('shown.bs.tab', function() {
                    setTimeout(() => {
                        if (map) {
                            map.invalidateSize();
                        }
                    }, 300);
                });
            }
        });

        // Rest of your existing functions (startExtraction, checkProgress, showResults, etc.)
        // ... keep all your existing functions unchanged ...

        async function startExtraction() {
            const targetDate = document.getElementById('targetDate').value;
            const departments = document.getElementById('departments').value.split(',').map(d => d.trim()).filter(d => d);
            const maxRecords = parseInt(document.getElementById('maxRecords').value);

            if (!targetDate) {
                alert('Please select a target date');
                return;
            }

            if (departments.length === 0) {
                alert('Please enter at least one department code');
                return;
            }

            // Show loading state
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('instructions').classList.add('d-none');

            try {
                const response = await fetch('/extract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        target_date: targetDate,
                        max_records: maxRecords,
                        departments: departments
                    })
                });

                const data = await response.json();
                currentJobId = data.job_id;

                // Show status area
                document.getElementById('statusArea').classList.remove('d-none');
                document.getElementById('loadingSpinner').style.display = 'none';

                // Start checking progress
                checkProgress();

            } catch (error) {
                console.error('Error starting extraction:', error);
                alert('Error starting extraction: ' + error.message);
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        async function checkProgress() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/job/${currentJobId}`);
                const data = await response.json();

                document.getElementById('statusMessage').textContent = data.message;
                
                // Update progress based on status
                let progress = 0;
                if (data.status === 'processing') {
                    progress = 50;
                } else if (data.status === 'completed') {
                    progress = 100;
                    clearInterval(checkInterval);
                    showResults(data);
                }

                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = `${progress}%`;

                if (data.status !== 'completed') {
                    checkInterval = setTimeout(checkProgress, 2000);
                }

            } catch (error) {
                console.error('Error checking progress:', error);
            }
        }

        function showResults(data) {
            // Update statistics
            document.getElementById('totalRecords').textContent = data.total_records;
            document.getElementById('filteredRecords').textContent = data.filtered_records;
            document.getElementById('statsArea').classList.remove('d-none');
            
            // Show download buttons
            document.getElementById('downloadArea').classList.remove('d-none');

            // Show department distribution chart
            if (data.department_distribution && Object.keys(data.department_distribution).length > 0) {
                createDepartmentChart(data.department_distribution);
                document.getElementById('chartArea').classList.remove('d-none');
                
                // Update map with department data
                updateMapWithData(data.department_distribution);
            }
        }

        function createDepartmentChart(distribution) {
            const ctx = document.getElementById('departmentChart').getContext('2d');
            
            if (departmentChart) {
                departmentChart.destroy();
            }

            const departments = Object.keys(distribution);
            const counts = Object.values(distribution);

            departmentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: departments,
                    datasets: [{
                        label: 'Number of Records',
                        data: counts,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        async function downloadFullData() {
            if (!currentJobId) return;
            
            try {
                const response = await fetch(`/download/${currentJobId}/full`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Get filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `BOAMP_Full_Results_${new Date().toISOString().split('T')[0]}.xlsx`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1];
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Error downloading full data:', error);
                alert('Error downloading data: ' + error.message);
            }
        }

        async function downloadFilteredData() {
            if (!currentJobId) return;
            
            try {
                const response = await fetch(`/download/${currentJobId}/filtered`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Get filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `BOAMP_Filtered_Results_${new Date().toISOString().split('T')[0]}.xlsx`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1];
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Error downloading filtered data:', error);
                alert('Error downloading data: ' + error.message);
            }
        }
        
        // Initialize only the basic functionality when page loads
        window.onload = function() {
            // Map will be initialized when user clicks the map tab
            console.log('Page loaded. Map will initialize when Map View tab is clicked.');
        };
    </script>
</body>
</html>